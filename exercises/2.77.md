## Exercise 2.77

<h1 id="figure-2.24" style="margin:0; padding:0;"></h2>

![Figure 2.24](../assets/figure-2.24.png)

Louis Reasoner tries to evaluate the expression `(magnitude z)` where z is the
object shown in [Figure 2.24](#figure-2.24). To his surprise, instead of the
answer $5$ he gets an error message from `apply-generic`, saying there is no
method for the operation `magnitude` on the types `(complex)`. He shows this
interaction to Alyssa P. Hacker, who says “The problem is that the
complex-number selectors were never defined for `complex` numbers, just for
`polar` and `rectangular` numbers. All you have to do to make this work is add
the following to the `complex` package:”

```scheme
(put 'real-part '(complex) real-part)
(put 'imag-part '(complex) imag-part)
(put 'magnitude '(complex) magnitude)
(put 'angle '(complex) angle)
```

Describe in detail why this works. As an example, trace through all the
procedures called in evaluating the expression `(magnitude z)` where `z` is the
object shown in [Figure 2.24](#figure-2.24). In particular, how many times is
`apply-generic` invoked? What procedure is dispatched to in each case?

## Solution

This works because somewhere in our system, we have the code that defines
`magnitude` as a generic operation, and after implementing what Alyssa has
suggested, we are installing the generic `magnitude` itself as the method for
the type `complex`. Concretely, after:

```scheme
(define (magnitude z) (apply-generic 'magnitude z))

(define (install-complex-package)
  ;; ....
  (put 'magnitude '(complex) magnitude)
'done)
```

the method table contains:

> For operation `magnitude` on type `(complex)`, dispatch the generic
> `magnitude` procedure

Note that the `complex` layer does not compute anything, just forwards the
operation back into the generic system, stripping one level of tagging, and an
infinite loop does not happen because the type changes from `(complex)` to
`(rectangular)`, so the second dispatch goes somewhere different.

Now we must remember that `apply-generic` looks up a method in the global
operation table using the operation name and the type tag(s) of the argument(s),
then applies that method to the contents of the tagged data:

```
(magnitude z)
> (apply-generic 'magnitude (complex rectangular 3 . 4))
```

Lookup:

```
(get 'magnitude '(complex)) -> magnitude
```

So:

```
(magnitude (rectangular 3 . 4))
> (apply-generic 'magnitude (rectangular 3 . 4))
```

Lookup:

```
(get 'magnitude '(rectangular)) -> rectangular-magnitude
```

So:

```
(rectangular-magnitude (3 . 4))
> 5
```

`apply-generic` is invoked twice:

1. First `apply-generic` selects the `magnitude` method for type `(complex)`,
   which is the generic procedure `magnitude` itself
2. Second `apply-generic` selects the `magnitude` method for type
   `(rectangular)` which is the internal procedure `rectangular-magnitude` that
   calculates the magnitude from real and imaginary parts.
